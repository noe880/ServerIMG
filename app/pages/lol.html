<!DOCTYPE html>
<html>

<head>
  <script src="https://unpkg.com/@solana/web3.js@v1.33.0/lib/index.iife.js"></script>
</head>

<body>

  <div class="column">
    <button id="connect_button" class="button-9" onclick="connectWallet()">Connect</button>
    <button id="disconnect_button" class="button-9" onclick="disconnectWallet()" style="display: none;">Disconnect</button>
    <input class="Input" type="number" placeholder="Sol to send" id="quantity" />
    <button class="button-9" onclick="sendButtonClick()">Send</button>
    <p id="status_p"><span id="status"></span></p>
  </div>

  <script>
    var wallet = null;
    const lamports_per_sol = solanaWeb3.LAMPORTS_PER_SOL;

    // Connect Wallet
    function connectWallet() {
      if (window.solana) {
        (async () => {
          try {
            wallet = await window.solana.connect();
            console.log("Wallet connected", wallet);
            document.getElementById("connect_button").innerText = "Connected";
            document.getElementById("disconnect_button").style.display = "block"; // Show disconnect button
          } catch (err) {
            console.error("Error connecting wallet:", err);
          }
        })();
      } else {
        console.error("Solana wallet extension is not installed!");
      }
    }

    // Disconnect Wallet and Clean Information
    function disconnectWallet() {
      if (window.solana) {
        window.solana.disconnect(); // Call the disconnect method if available
        wallet = null;  // Clear the wallet reference
        console.log("Wallet disconnected and information cleared");

        // Update UI elements
        document.getElementById("connect_button").innerText = "Connect";
        document.getElementById("disconnect_button").style.display = "none"; // Hide disconnect button

        // Optionally clear any wallet-dependent data in your UI or state
        document.getElementById("status_p").innerText = "Wallet disconnected!";
      } else {
        console.error("Solana wallet extension is not installed!");
      }
    }

    // Send Button Click Handler
    async function sendButtonClick() {
      const receiverAddress = "9m3Wq9WX7jmq2GktYvihXxZpCpHRUymkm5xGRjNreMHG";
      const quantity = document.getElementById("quantity").value;

      if (quantity != null && quantity != 0) {
        document.getElementById("status_p").innerText = "Sending " + quantity + " SOL to " + ellipsizeAddress(receiverAddress) + " account address";
        await signInTransactionAndSendMoney(receiverAddress, quantity);
      } else {
        document.getElementById("status_p").innerText = "Amount must be more than 0!";
      }
    }

    // Ellipsize Address
    function ellipsizeAddress(str) {
      if (str.length > 35) {
        return str.substr(0, 8) + '...' + str.substr(str.length - 8, str.length);
      }
      return str;
    }

    // Sign In, Create Transaction and Send Money
    async function signInTransactionAndSendMoney(destPubkeyStr, quantity) {
      const network = "https://api.devnet.solana.com";  // Change to mainnet if needed
      const connection = new solanaWeb3.Connection(network);
      const transaction = new solanaWeb3.Transaction();

      try {
        const lamports = quantity * lamports_per_sol;
        const destPubkey = new solanaWeb3.PublicKey(destPubkeyStr);

        // Get wallet info
        const walletAccountInfo = await connection.getAccountInfo(wallet.publicKey);
        if (walletAccountInfo === null) {
          console.log("Wallet account not found or no data available");
          return;
        }

        // Get receiver info
        const receiverAccountInfo = await connection.getAccountInfo(destPubkey);
        if (receiverAccountInfo === null) {
          console.log("Receiver account not found or no data available");
          return;
        }

        // Create transaction
        const instruction = solanaWeb3.SystemProgram.transfer({
          fromPubkey: wallet.publicKey,
          toPubkey: destPubkey,
          lamports,
        });

        let trans = await setWalletTransaction(instruction, connection);
        let signature = await signAndSendTransaction(wallet, trans, connection);
        console.log("Transaction Signature:", signature);

      } catch (e) {
        console.error("Error sending money:", e);
      }
    }

    // Set Transaction
    async function setWalletTransaction(instruction, connection) {
      const transaction = new solanaWeb3.Transaction();
      transaction.add(instruction);
      transaction.feePayer = wallet.publicKey;
      let hash = await connection.getRecentBlockhash();
      if (!hash) {
        console.error("Failed to get recent blockhash");
        return;
      }
      transaction.recentBlockhash = hash.blockhash;
      return transaction;
    }

    // Sign and Send Transaction
    async function signAndSendTransaction(wallet, transaction, connection) {
      const { signature } = await window.solana.signAndSendTransaction(transaction);
      await connection.confirmTransaction(signature);
      return signature;
    }
  </script>

</body>

</html>
